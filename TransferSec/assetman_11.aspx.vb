Imports System.Data
Imports System.Data.SqlClient
Imports System.IO

Partial Class Orders
    Inherits System.Web.UI.Page
    Dim constr As String = (System.Configuration.ConfigurationManager.AppSettings("connpath"))
    Dim cn As New SqlConnection(constr)
    Dim cmd As SqlCommand
    Dim adp As SqlDataAdapter
    Dim ds As New DataSet
    Dim maxholder As Integer = 0
    Public Sub msgbox(ByVal strMessage As String)

        'finishes server processing, returns to client.
        Dim strScript As String = "<script language=JavaScript>"
        strScript += "window.alert(""" & strMessage & """);"
        strScript += "</script>"
        Dim lbl As New System.Web.UI.WebControls.Label
        lbl.Text = strScript
        Page.Controls.Add(lbl)

    End Sub
    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load

        Page.MaintainScrollPositionOnPostBack = True
        If (Not IsPostBack) Then

            getcompanies()
            loadcomboforassetmanagers()
            '  firstcombo()


        End If
        If Session("finish") = "yes" Then
            Session("finish") = ""
            msgbox("Sent for Approval")
        End If
    End Sub

    Public Sub loadcomboforassetmanagers()
        Dim dsport As New DataSet
        cmd = New SqlCommand("select * from (select 0 as nr,  'ALL' AS code, 'ALL' as AssetMananger union  select 1 as nr, AssetManagerCode as code, p.AssetMananger from  para_AssetManager p) j order by nr", cn)
        adp = New SqlDataAdapter(cmd)
        adp.Fill(dsport, "trans")
        If (dsport.Tables(0).Rows.Count > 0) Then

            cmbassetmanager0.DataSource = dsport
            cmbassetmanager0.TextField = "AssetMananger"
            cmbassetmanager0.ValueField = "code"
            cmbassetmanager0.DataBind()

        End If
    End Sub
    Public Function correctaccounts(cdsno As String) As Boolean
        Dim dsport As New DataSet
        cmd = New SqlCommand("select * from accounts_clients where cds_number='" + cdsno + "'", cn)
        adp = New SqlDataAdapter(cmd)
        adp.Fill(dsport, "trans")
        If (dsport.Tables(0).Rows.Count > 0) Then
            Return True
        Else
            Return False

        End If

    End Function
    Public Function correctassetmanager(assetmanager As String) As Boolean
        Dim dsport As New DataSet
        cmd = New SqlCommand("select * from para_assetManager where AssetManagerCode='" + assetmanager + "'", cn)
        adp = New SqlDataAdapter(cmd)
        adp.Fill(dsport, "trans")
        If (dsport.Tables(0).Rows.Count > 0) Then
            Return True
        Else
            Return False

        End If

    End Function
    Public Function correctcompany(company As String) As Boolean
        Dim dsport As New DataSet
        cmd = New SqlCommand("select * from para_company where company='" + company + "'", cn)
        adp = New SqlDataAdapter(cmd)
        adp.Fill(dsport, "trans")
        If (dsport.Tables(0).Rows.Count > 0) Then
            Return True
        Else
            Return False

        End If

    End Function
    'Public Sub firstcombo()
    '    Dim dsport As New DataSet
    '    cmd = New SqlCommand("select AssetManagerCode as code, p.AssetMananger from  para_AssetManager p", cn)
    '    adp = New SqlDataAdapter(cmd)
    '    adp.Fill(dsport, "trans")
    '    If (dsport.Tables(0).Rows.Count > 0) Then
    '        cmbassetmanager.DataSource = dsport
    '        cmbassetmanager.TextField = "AssetMananger"
    '        cmbassetmanager.ValueField = "code"
    '        cmbassetmanager.DataBind()
    '    End If

    'End Sub
    Public Sub deleteprev(assetmanager As String, company As String, accountnumber As String)
        cmd = New SqlCommand("delete from recon_AssetManager where AssetManager='" + assetmanager + "' and Company='" + company + "' and AccountNumber='" + accountnumber + "' ", cn)
        If (cn.State = ConnectionState.Open) Then
            cn.Close()
        End If
        cn.Open()
        cmd.ExecuteNonQuery()
        cn.Close()
    End Sub

    Protected Sub btnupload_Click(sender As Object, e As EventArgs)

        If fileupload1.HasFile Then
            Dim connectionString As String = ""
            Dim fileName2 As String = Path.GetFileName(fileupload1.PostedFile.FileName)


            Dim fileLocation As String = Server.MapPath("~/uploads/recon_" & Date.Now.ToString("ddMMyyyymmsss") & fileName2)
            fileupload1.SaveAs(fileLocation)
            Dim fileExtension As String = Path.GetExtension(fileupload1.PostedFile.FileName)
            If fileExtension = ".xls" Then
                connectionString = "Provider=Microsoft.Jet.OLEDB.4.0;Data Source=" & fileLocation & ";Extended Properties=""Excel 8.0;HDR=No;IMEX=1"""
            ElseIf fileExtension = ".xlsx" Then
                connectionString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & fileLocation & ";Extended Properties=""Excel 12.0;HDR=No;IMEX=1"""
            Else
                msgbox("File Type Invalid")
                Exit Sub
            End If
            'Create OleDB Connection and OleDb Command

            Dim conn As New OleDbConnection(connectionString)
            Dim cmd As New OleDbCommand()

            cmd.CommandType = System.Data.CommandType.Text
            cmd.Connection = conn

            Dim dAdapter As New OleDbDataAdapter(cmd)

            Dim dtExcelRecords As New DataTable()

            conn.Open()

            Dim dtExcelSheetName As DataTable = conn.GetOleDbSchemaTable(OleDbSchemaGuid.Tables, Nothing)
            Dim getExcelSheetName As String = dtExcelSheetName.Rows(0)("Table_Name").ToString()
            cmd.CommandText = "Select * FROM [" & getExcelSheetName & "]"
            dAdapter.SelectCommand = cmd
            dAdapter.Fill(dtExcelRecords)






            Dim x As Integer = 0
            For x = 1 To dtExcelRecords.Rows.Count - 1                                                                                                                                                                                      '                                                                                                                                                                                                                                                                                                                               ImportID,Company,Date_trade,CDS_Ref,Date_Settlement,Client_Id,Other_Names,Surname,Buy_Sell,Quantity,Price,UploadDate)
                '                                                                                                                                                                                                                  ImportID,                      Date_trade,                                         CDS_Ref,                                             Date_Settlement,                                        Client_Id,                             Surname,                                        Buy_Sell,                                        Quantity,                                   Price,                                              UploadDate


                Dim dr = dtExcelRecords.Rows(x)
                If correctaccounts(dr.Item(1).ToString) = False Then
                    msgbox("There is an invalid Account in the system. Invalid account is " + dr.Item(1).ToString + "")
                    Exit Sub
                End If
                If correctassetmanager(dr.Item(4).ToString) = False Then
                    msgbox("There is an invalid Asset Manager in the system. Invalid Asset Manager is " + dr.Item(4).ToString + "")
                    Exit Sub
                End If

                If correctcompany(dr.Item(5).ToString) = False Then
                    msgbox("There is an invalid Company in the system. Invalid Company is " + dr.Item(5).ToString + "")
                    Exit Sub
                End If


                Dim cmd2 As New SqlCommand
                Dim cmdStr As String = "insert into Recon_AssetManager ([DateUploaded] ,[ForDate] ,[AccountNumber] ,[CSDAccount] ,[Name] ,[AssetManager],[Company] ,[Units] ,[MarketValue],[UploadedBy],[SystemUploadBy], [RecordDate]) values (@DateUploaded ,@ForDate ,@AccountNumber ,@CSDAccount ,@Name ,@AssetManager,@Company ,@Units ,@MarketValue,@UploadedBy,@SystemUploadBy, getdate())"
                deleteprev(dr.Item(4).ToString, dr.Item(5).ToString, dr.Item(1).ToString)
                cmd2 = New SqlCommand(cmdStr, cn)
                cmd2.Parameters.AddWithValue("@DateUploaded", dr.Item(0).ToString)
                cmd2.Parameters.AddWithValue("@ForDate", dtdate.Text)
                cmd2.Parameters.AddWithValue("@AccountNumber", dr.Item(1).ToString)
                cmd2.Parameters.AddWithValue("@CSDAccount", dr.Item(2).ToString)
                cmd2.Parameters.AddWithValue("@Name", dr.Item(3).ToString)
                cmd2.Parameters.AddWithValue("@AssetManager", dr.Item(4).ToString)
                cmd2.Parameters.AddWithValue("@Company", dr.Item(5).ToString)
                cmd2.Parameters.AddWithValue("@Units", dr.Item(6).ToString.Replace(",", ""))
                cmd2.Parameters.AddWithValue("@MarketValue", dr.Item(7).ToString.Replace(",", ""))
                cmd2.Parameters.AddWithValue("@UploadedBy", dr.Item(8).ToString)
                cmd2.Parameters.AddWithValue("@SystemUploadBy", Session("Username"))




                Try
                    cn.Open()
                    cmd2.ExecuteNonQuery()
                    cn.Close()
                Catch ex As Exception

                End Try



            Next
            conn.Close()

        Else

        End If
        msgbox("upload successful")

    End Sub

    Public Sub cleartable()
        cmd = New SqlCommand("truncate table unitAccounts  ", cn)
        If (cn.State = ConnectionState.Open) Then
            cn.Close()
        End If
        cn.Open()
        cmd.ExecuteNonQuery()
        cn.Close()
    End Sub


    Public Sub getcompanies()
        cmd = New SqlCommand("select * from ( select 0 as nr,  'ALL' as company union SELECT 1 as nr , company from para_company) j order by nr", cn)
        adp = New SqlDataAdapter(cmd)
        Dim ds1 As New DataSet
        ds1.Clear()
        adp.Fill(ds1, "company")
        If ds1.Tables(0).Rows.Count > 0 Then
            cmbcompany.DataSource = ds1
            cmbcompany.TextField = "company"
            cmbcompany.ValueField = "company"
            cmbcompany.DataBind()
        End If
    End Sub

    Private Sub MesgBox(ByVal sMessage As String)
        Dim msg As String
        msg = "<script language='javascript'>"
        msg += "alert('" & sMessage & "');"
        msg += "<" & "/script>"
        Response.Write(msg)
    End Sub

    Protected Sub cmbtype_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbtype.SelectedIndexChanged

    End Sub
    Protected Sub btnupload0_Click(sender As Object, e As EventArgs) Handles btnupload0.Click
        If RadioButtonList1.SelectedItem.Text = "Un-Authorized" Then

            ASPxGridView2.DataSource = Nothing
            ASPxGridView2.DataBind()

            getview()
        Else
            ASPxGridView2.DataSource = Nothing
            ASPxGridView2.DataBind()

            getview_authorized()
        End If




    End Sub

    Public Sub getview()

        Try

            ASPxGridView2.DataSource = Nothing
            ASPxGridView2.DataBind()
            If lstSearchAcc.SelectedIndex = -1 Then
                If cmbassetmanager0.SelectedItem.Text = "ALL" And cmbcompany.SelectedItem.Text <> "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "'  and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less value at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More value at Asset Manager'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text <> "ALL" And cmbcompany.SelectedItem.Text <> "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "' and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less value at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More value at Asset Manager'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text <> "ALL" And cmbcompany.SelectedItem.Text = "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "' and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less value at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More value at Asset Manager'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text = "ALL" And cmbcompany.SelectedItem.Text = "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "'  and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less value at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More value at Asset Manager'", cn)
                    End If
                End If
            Else
                If cmbassetmanager0.SelectedItem.Text = "ALL" And cmbcompany.SelectedItem.Text <> "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Balancing' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "'  and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients) ", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text <> "ALL" And cmbcompany.SelectedItem.Text <> "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Balancing' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "' and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text <> "ALL" And cmbcompany.SelectedItem.Text = "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "' and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text = "ALL" And cmbcompany.SelectedItem.Text = "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "'  and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    End If
                End If
            End If



            adp = New SqlDataAdapter(cmd)
            Dim ds1 As New DataSet
            ds1.Clear()
            adp.Fill(ds1, "company")
            If ds1.Tables(0).Rows.Count > 0 Then
                ASPxGridView2.DataSource = ds1.Tables(0)
            Else
                ASPxGridView2.DataSource = Nothing
            End If
            ASPxGridView2.DataBind()
        Catch ex As Exception
            msgbox(ex.Message)
        End Try
    End Sub
    Public Sub getview_authorized()

        Try

            ASPxGridView2.DataSource = Nothing
            ASPxGridView2.DataBind()
            If lstSearchAcc.SelectedIndex = -1 Then
                If cmbassetmanager0.SelectedItem.Text = "ALL" And cmbcompany.SelectedItem.Text <> "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where [status]='APPROVED' AND company='" + cmbcompany.SelectedItem.Text + "'  and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less value at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More value at Asset Manager'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text <> "ALL" And cmbcompany.SelectedItem.Text <> "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where [status]='APPROVED' AND company='" + cmbcompany.SelectedItem.Text + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "' and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less value at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More value at Asset Manager'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text <> "ALL" And cmbcompany.SelectedItem.Text = "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where [status]='APPROVED' AND company='" + cmbcompany.SelectedItem.Text + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "' and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less value at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More value at Asset Manager'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text = "ALL" And cmbcompany.SelectedItem.Text = "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More units at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where [status]='APPROVED' AND company='" + cmbcompany.SelectedItem.Text + "'  and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less value at Asset Manager'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More value at Asset Manager'", cn)
                    End If
                End If
            Else
                If cmbassetmanager0.SelectedItem.Text = "ALL" And cmbcompany.SelectedItem.Text <> "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Balancing' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "'  and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients) ", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company  and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text <> "ALL" And cmbcompany.SelectedItem.Text <> "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Balancing' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where company='" + cmbcompany.SelectedItem.Text + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "' and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and Company=@company  and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text <> "ALL" And cmbcompany.SelectedItem.Text = "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where [status]='APPROVED' AND company='" + cmbcompany.SelectedItem.Text + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "' and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='Less value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date and AssetManager='" + cmbassetmanager0.SelectedItem.Value.ToString + "'  group by t.CDS_Number, a.Surname, a.Forenames, t.Company) j) z  where z.Status='More value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    End If
                ElseIf cmbassetmanager0.SelectedItem.Text = "ALL" And cmbcompany.SelectedItem.Text = "ALL" Then
                    If cmbtype.SelectedItem.Text = "Balancing" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Balancing'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number  and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Units in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less units at Asset Manager' when j.Variance<0 then 'More units at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0) as [C-Trade Holding],   (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Holding]  ,isnull(sum(t.shares),0)-  (select isnull(sum(units),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "') as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date  group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More units at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Not found in C-Trade" Then
                        cmd = New SqlCommand("select AccountNumber as [Account No], [Name], AssetManager, Company as [Security], Units, MarketValue, RecordDate from Recon_AssetManager where [status]='APPROVED' AND company='" + cmbcompany.SelectedItem.Text + "'  and convert(date, Dateuploaded)<='" + dtdateview.Text + "' and AccountNumber not in (select cds_number from Accounts_clients)", cn)
                    ElseIf cmbtype.SelectedItem.Text = "More Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0) as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number    and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='Less value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    ElseIf cmbtype.SelectedItem.Text = "Less Value in C-Trade" Then
                        cmd = New SqlCommand("declare @company nvarchar(50)='" + cmbcompany.SelectedItem.Text + "';  declare @date date='" + dtdateview.Text + "' select * from (select *, case when j.variance>0 then 'Less value at Asset Manager' when j.Variance<0 then 'More value at Asset Manager' else 'Balancing' end as [Status] from ( select t.cds_number as [Account No], a.Surname+' '+a.Forenames as [Names],   t.Company as [Security], AssetManager, isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)  as [C-Trade Value],   (select isnull(sum(Marketvalue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Asset Manager Value]  ,isnull(sum(t.shares),0)*ISNULL((select Current_price  from Market_data where ticker=t.Company),0)-  (select isnull(sum(MarketValue),0) from Recon_AssetManager where [status]='APPROVED' AND company=t.Company and AccountNumber=t.CDS_Number and convert(date, dateUploaded)<='" + dtdateview.Date + "' ) as [Variance]  from trans_recon t, Accounts_Clients a where a.CDS_Number = t.CDS_Number   and convert(date, t.date_created)<=@date   group by t.CDS_Number, a.Surname, a.Forenames, t.Company,t.AssetManager) j) z  where z.Status='More value at Asset Manager' and  z.[Account No]='" + lstSearchAcc.SelectedItem.Value.ToString + "'", cn)
                    End If
                End If
            End If



            adp = New SqlDataAdapter(cmd)
            Dim ds1 As New DataSet
            ds1.Clear()
            adp.Fill(ds1, "company")
            If ds1.Tables(0).Rows.Count > 0 Then
                ASPxGridView2.DataSource = ds1.Tables(0)
            Else
                ASPxGridView2.DataSource = Nothing
            End If
            ASPxGridView2.DataBind()
        Catch ex As Exception
            msgbox(ex.Message)
        End Try
    End Sub
    Protected Sub lstSearchAcc_SelectedIndexChanged(sender As Object, e As EventArgs) Handles lstSearchAcc.SelectedIndexChanged

    End Sub
    Protected Sub ASPxButton4_Click(sender As Object, e As EventArgs) Handles ASPxButton4.Click
        Try


            Dim ds As New DataSet
            cmd = New SqlCommand("select cds_number+' '+isnull(forenames,'')+' '+isnull(middlename,'')+' '+isnull(surname,'') as names, cds_number from accounts_clients where cds_number+' '+isnull(surname,'')+' '+isnull(middlename,'')+' '+isnull(forenames,'') like '%" + txtAccountNo.Text + "%' and AccountState='A' order by cds_number", cn)
            adp = New SqlDataAdapter(cmd)
            adp.Fill(ds, "names")
            If (ds.Tables(0).Rows.Count > 0) Then
                lstSearchAcc.DataSource = ds
                lstSearchAcc.TextField = "names"
                lstSearchAcc.ValueField = "cds_number"
                lstSearchAcc.DataBind()

            End If
        Catch ex As Exception

        End Try
    End Sub
    Protected Sub btnupload1_Click(sender As Object, e As EventArgs) Handles btnupload1.Click
        ' getview()
        If RadioButtonList1.SelectedItem.Text = "Un-Authorized" Then
            ASPxGridView2.DataSource = Nothing
            ASPxGridView2.DataBind()

            getview()
        Else
            ASPxGridView2.DataSource = Nothing
            ASPxGridView2.DataBind()

            getview_authorized()
        End If


        ASPxGridViewExporter1.WriteXlsToResponse()


    End Sub
End Class
